machine:
  python:
    version: 3.4.1
  services:
    - docker

dependencies:
  pre:
    - pip install -r requirements_test.txt
    - docker build -t minicomi .

test:
  override:
    - pep8 .
    - coverage run --source='.' manage.py test

    - docker run -d --name minicomi-postgres postgres
    - docker run -d
      --link minicomi-postgres:postgres
      -p 5000:5000
      -e MINICOMI_DATABASE_PASSWORD=butt
      -e SUPERUSER_NAME=$SUPERUSER_NAME
      -e SUPERUSER_PASSWORD=$SUPERUSER_PASSWORD
      -e SUPERUSER_EMAIL=$SUPERUSER_EMAIL
      minicomi

    # Wait for the app to become available
    - while ! curl -I localhost:5000; do sleep 3; done

    - MINICOMI_BASE_URL='http://localhost:5000' behave
